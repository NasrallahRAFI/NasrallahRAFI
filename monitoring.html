<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Pump Monitoring</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #2ecc71;
            --info: #1abc9c;
            --border-radius: 8px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header-title h1 {
            font-size: 1.8rem;
            color: var(--secondary);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online {
            background-color: var(--success);
        }
        
        .offline {
            background-color: var(--danger);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .card-header {
            padding: 15px 20px;
            background: var(--secondary);
            color: white;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .data-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .data-label {
            font-weight: 500;
            color: #7f8c8d;
        }
        
        .data-value {
            font-weight: 600;
        }
        
        .gauge {
            height: 10px;
            background: #f1f1f1;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .gauge-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <h1>Monitoring Pompe Solaire</h1>
            </div>
            <div class="connection-status">
                <div class="status-indicator offline" id="connection-status"></div>
                <span id="connection-text">Déconnecté</span>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Données Électriques</h3>
                </div>
                <div class="card-body">
                    <div class="data-item">
                        <span class="data-label">Tension Panneau</span>
                        <span class="data-value" id="solar-voltage">0 V</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Courant Panneau</span>
                        <span class="data-value" id="solar-current">0 A</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Puissance</span>
                        <span class="data-value" id="solar-power">0 W</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Batterie</span>
                        <span class="data-value" id="battery-level">0%</span>
                    </div>
                    <div class="gauge">
                        <div class="gauge-fill" id="battery-gauge" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-tint"></i> Données Pompe</h3>
                </div>
                <div class="card-body">
                    <div class="data-item">
                        <span class="data-label">Débit d'eau</span>
                        <span class="data-value" id="water-flow">0 L/min</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Pression</span>
                        <span class="data-value" id="water-pressure">0 bar</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Température</span>
                        <span class="data-value" id="pump-temperature">0°C</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">État</span>
                        <span class="data-value" id="pump-status">Inconnu</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-sun"></i> Environnement</h3>
                </div>
                <div class="card-body">
                    <div class="data-item">
                        <span class="data-label">Ensoleillement</span>
                        <span class="data-value" id="sunlight">0 W/m²</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Température</span>
                        <span class="data-value" id="ambient-temperature">0°C</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Humidité</span>
                        <span class="data-value" id="humidity">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-water"></i> Réservoir</h3>
                </div>
                <div class="card-body">
                    <div class="data-item">
                        <span class="data-label">Niveau d'eau</span>
                        <span class="data-value" id="water-level">0%</span>
                    </div>
                    <div class="gauge">
                        <div class="gauge-fill" id="water-gauge" style="width: 0%"></div>
                    </div>
                    <div class="data-item">
                        <span class="data-label">pH</span>
                        <span class="data-value" id="water-ph">0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration MQTT
        const mqttConfig = {
            host: "508205b2e19c4a7fad9828d3961d6424.s1.eu.hivemq.cloud",
            port: 8884,
            clientId: "webclient_" + Math.random().toString(16).substr(2, 8),
            topics: [
                "solar-voltage",
                "solar-current",
                "solar-power",
                "battery-level",
                "water-flow",
                "water-pressure",
                "pump-temperature",
                "pump-status",
                "sunlight",
                "ambient-temperature",
                "humidity",
                "water-level",
                "water-ph"
            ]
        };
        
        let mqttClient = null;
        
        // Initialiser la connexion MQTT
        function initMQTT() {
            // Récupérer les identifiants depuis le localStorage
            const username = localStorage.getItem('mqtt_username');
            const password = localStorage.getItem('mqtt_password');
            
            if (!username || !password) {
                window.location.href = "login.html";
                return;
            }
            
            mqttClient = new Paho.MQTT.Client(
                mqttConfig.host,
                mqttConfig.port,
                mqttConfig.clientId
            );
            
            const options = {
                userName: username,
                password: password,
                useSSL: true,
                onSuccess: onConnect,
                onFailure: onFailure
            };
            
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;
            
            mqttClient.connect(options);
        }
        
        function onConnect() {
            updateConnectionStatus(true);
            
            // S'abonner à tous les topics
            mqttConfig.topics.forEach(topic => {
                mqttClient.subscribe(topic);
                console.log("Subscribed to:", topic);
            });
        }
        
        function onFailure(message) {
            updateConnectionStatus(false);
            console.error("Connection failed:", message.errorMessage);
            
            // Reconnect after 5 seconds
            setTimeout(initMQTT, 5000);
        }
        
        function onConnectionLost(responseObject) {
            updateConnectionStatus(false);
            
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost:", responseObject.errorMessage);
            }
            
            // Try to reconnect
            setTimeout(initMQTT, 5000);
        }
        
        function onMessageArrived(message) {
            const topic = message.destinationName;
            const value = message.payloadString;
            
            console.log("Message received:", topic, value);
            
            // Mettre à jour l'interface en fonction du topic
            updateUI(topic, value);
        }
        
        function updateUI(topic, value) {
            const element = document.getElementById(topic);
            if (!element) return;
            
            switch(topic) {
                case 'battery-level':
                case 'water-level':
                    element.textContent = value + "%";
                    document.getElementById(topic + '-gauge').style.width = value + "%";
                    break;
                case 'pump-status':
                    element.textContent = getStatusText(value);
                    break;
                default:
                    element.textContent = value + getUnit(topic);
            }
        }
        
        function getUnit(topic) {
            const units = {
                'solar-voltage': ' V',
                'solar-current': ' A',
                'solar-power': ' W',
                'water-flow': ' L/min',
                'water-pressure': ' bar',
                'pump-temperature': '°C',
                'sunlight': ' W/m²',
                'ambient-temperature': '°C',
                'humidity': '%',
                'water-ph': ''
            };
            
            return units[topic] || '';
        }
        
        function getStatusText(status) {
            const statusMap = {
                '0': 'Arrêté',
                '1': 'En marche',
                '2': 'En erreur'
            };
            
            return statusMap[status] || status;
        }
        
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            if (connected) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'Connecté';
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Déconnecté';
            }
        }
        
        // Démarrer la connexion quand la page est chargée
        document.addEventListener('DOMContentLoaded', initMQTT);
    </script>
</body>
</html>
