<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f4f8;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .section {
            background: #fff;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .section-title {
            padding: 10px;
            background: #2c3e50;
            color: #fff;
            cursor: pointer;
        }
        .section-content {
            padding: 10px;
            display: none;
        }
        .section-content.active {
            display: block;
        }
        .topic-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .topic-label {
            font-weight: bold;
        }
        .topic-value {
            color: #2c3e50;
        }
        button#logout {
            padding: 10px 20px;
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        button#logout:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <h1 id="client-title"></h1>
    <div id="sections-container">
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">1. Données Électriques</div>
            <div class="section-content">
                <div class="topic-row"><span class="topic-label">Tension entrée panneau solaire :</span><span class="topic-value" id="solar_in_voltage">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Courant entrée panneau solaire :</span><span class="topic-value" id="solar_in_current">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Tension sortie panneau solaire :</span><span class="topic-value" id="solar_out_voltage">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Courant sortie panneau solaire :</span><span class="topic-value" id="solar_out_current">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Tension batterie :</span><span class="topic-value" id="battery_voltage">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Courant batterie :</span><span class="topic-value" id="battery_current">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Niveau de charge batterie :</span><span class="topic-value" id="battery_level">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Courant charge/décharge batterie :</span><span class="topic-value" id="battery_charge_current">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Puissance générée panneaux :</span><span class="topic-value" id="solar_power">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Consommation pompe :</span><span class="topic-value" id="pump_consumption">N/A</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">2. Performances de la Pompe</div>
            <div class="section-content">
                <div class="topic-row"><span class="topic-label">Débit d'eau :</span><span class="topic-value" id="water_flow">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Pression d'eau :</span><span class="topic-value" id="water_pressure">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Température moteur :</span><span class="topic-value" id="motor_temp">N/A</span></div>
                <div class="topic-row"><span class="topic-label">État de fonctionnement :</span><span class="topic-value" id="pump_state">N/A</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">3. Données Solaires et Environnementales</div>
            <div class="section-content">
                <div class="topic-row"><span class="topic-label">Ensoleillement :</span><span class="topic-value" id="solar_irradiance">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Température ambiante :</span><span class="topic-value" id="ambient_temp">N/A</span></div>
                <div class="topic-row"><span class="topic-label">État panneaux solaires :</span><span class="topic-value" id="solar_panel_status">N/A</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">4. Surveillance du Réservoir/Stockage d'Eau</div>
            <div class="section-content">
                <div class="topic-row"><span class="topic-label">Niveau d'eau :</span><span class="topic-value" id="water_level">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Qualité de l'eau :</span><span class="topic-value" id="water_quality">N/A</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">5. Données de Maintenance et Sécurité</div>
            <div class="section-content">
                <div class="topic-row"><span class="topic-label">Heures de fonctionnement :</span><span class="topic-value" id="operating_hours">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Alertes de panne :</span><span class="topic-value" id="failure_alerts">N/A</span></div>
                <div class="topic-row"><span class="topic-label">État des connexions :</span><span class="topic-value" id="connection_status">N/A</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">6. Données de Communication IoT</div>
            <div class="section-content">
                <div class="topic-row"><span class="topic-label">État connexion réseau :</span><span class="topic-value" id="network_status">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Latence des données :</span><span class="topic-value" id="data_latency">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Statut mises à jour :</span><span class="topic-value" id="update_status">N/A</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">7. Données Énergétiques et Efficacité</div>
            <div class="section-content">
                <div class="topic-row"><span class="topic-label">Rendement du système :</span><span class="topic-value" id="system_efficiency">N/A</span></div>
                <div class="topic-row"><span class="topic-label">Autonomie batterie :</span><span class="topic-value" id="battery_autonomy">N/A</span></div>
            </div>
        </div>
    </div>
    <button id="logout" onclick="logout()">Déconnexion</button>
    <script src="https://unpkg.com/mqtt@5.10.1/dist/mqtt.min.js"></script>
    <script>
        let client;

        // Rediriger vers index.html en cas d'actualisation si pas d'utilisateur
        window.onbeforeunload = function() {
            window.location.href = 'index.html';
        };

        // Récupérer le nom d'utilisateur depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        if (username) {
            document.getElementById('client-title').textContent = `Client : ${decodeURIComponent(username)}`;
        } else {
            window.location.href = 'index.html';
        }

        // Connexion MQTT
        const options = {
            host: '508205b2e19c4a7fad9828d3961d6424.s1.eu.hivemq.cloud',
            port: 8884,
            protocol: 'wss',
            path: '/mqtt',
            clientId: 'mqttjs_' + Math.random().toString(16).substr(2, 8),
            username: username,
            password: 'Nasrollah2003*' // Remplacez par une logique sécurisée pour le mot de passe
        };

        client = mqtt.connect(options);

        client.on('connect', () => {
            const topics = [
                'solar/in/voltage', 'solar/in/current', 'solar/out/voltage', 'solar/out/current',
                'battery/voltage', 'battery/current', 'battery/level', 'battery/charge_current',
                'solar/power', 'pump/consumption', 'water/flow', 'water/pressure', 'motor/temp',
                'pump/state', 'solar/irradiance', 'ambient/temp', 'solar/panel/status', 'water/level',
                'water/quality', 'operating/hours', 'failure/alerts', 'connection/status', 'network/status',
                'data/latency', 'update/status', 'system/efficiency', 'battery/autonomy'
            ];
            topics.forEach(topic => client.subscribe(topic));
        });

        client.on('message', (topic, message) => {
            const value = message.toString();
            const element = document.getElementById(topic.replace('/', '_'));
            if (element) element.textContent = value;
        });

        client.on('error', (err) => {
            console.log('Erreur MQTT:', err);
            window.location.href = 'index.html';
        });

        client.on('close', () => {
            window.location.href = 'index.html';
        });

        function toggleSection(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('active');
        }

        function logout() {
            if (client) client.end();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
