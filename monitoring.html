<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Pump Monitoring - HiveMQ</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #2ecc71;
            --info: #1abc9c;
            --border-radius: 8px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header-title {
            display: flex;
            align-items: center;
        }
        
        .header-title h1 {
            font-size: 1.8rem;
            color: var(--secondary);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin-left: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background: var(--success);
        }
        
        .status-disconnected {
            background: var(--danger);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            padding: 15px 20px;
            background: var(--secondary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 500;
            color: #7f8c8d;
        }
        
        .data-value {
            font-weight: 600;
        }
        
        .gauge-container {
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 10px;
        }
        
        .gauge {
            height: 10px;
            background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71);
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .gauge-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <h1>Solar Pump Monitoring</h1>
                <div class="connection-status">
                    <span class="status-indicator status-disconnected" id="mqtt-status"></span>
                    <span id="mqtt-status-text">Déconnecté</span>
                </div>
            </div>
            <div id="last-update" class="last-update">Dernière mise à jour: --</div>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Données Électriques</h3>
                </div>
                <div class="card-body">
                    <div class="data-item">
                        <span class="data-label">Tension panneau (V)</span>
                        <span class="data-value" id="solar-voltage">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Courant panneau (A)</span>
                        <span class="data-value" id="solar-current">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Puissance (W)</span>
                        <span class="data-value" id="solar-power">--</span>
                    </div>
                    <div class="gauge-container">
                        <div class="data-label">Niveau batterie</div>
                        <div class="gauge">
                            <div class="gauge-fill" id="battery-level-gauge" style="width: 0%"></div>
                        </div>
                        <div class="data-value"><span id="battery-level">--</span>%</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-tint"></i> Pompe à Eau</h3>
                </div>
                <div class="card-body">
                    <div class="data-item">
                        <span class="data-label">Débit (L/min)</span>
                        <span class="data-value" id="water-flow">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Pression (bar)</span>
                        <span class="data-value" id="water-pressure">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Température (°C)</span>
                        <span class="data-value" id="pump-temperature">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">État</span>
                        <span class="data-value" id="pump-status">--</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-sun"></i> Environnement</h3>
                </div>
                <div class="card-body">
                    <div class="data-item">
                        <span class="data-label">Ensoleillement (W/m²)</span>
                        <span class="data-value" id="solar-irradiance">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Température (°C)</span>
                        <span class="data-value" id="ambient-temperature">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Humidité (%)</span>
                        <span class="data-value" id="ambient-humidity">--</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-water"></i> Réservoir</h3>
                </div>
                <div class="card-body">
                    <div class="gauge-container">
                        <div class="data-label">Niveau d'eau</div>
                        <div class="gauge">
                            <div class="gauge-fill" id="water-level-gauge" style="width: 0%"></div>
                        </div>
                        <div class="data-value"><span id="water-level">--</span>%</div>
                    </div>
                    <div class="data-item">
                        <span class="data-label">pH</span>
                        <span class="data-value" id="water-ph">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Turbidité (NTU)</span>
                        <span class="data-value" id="water-turbidity">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration MQTT
        const mqttConfig = {
            host: "508205b2e19c4a7fad9828d3961d6424.s1.eu.hivemq.cloud",
            port: 8884, // WebSocket port
            clientId: "webclient_" + Math.random().toString(16).substr(2, 8),
            username: "votre_username", // Remplacez par vos identifiants HiveMQ
            password: "votre_password", // Remplacez par votre mot de passe HiveMQ
            topics: [
                "solar_voltage",
                "solar_current",
                "solar_power",
                "battery_level",
                "water_flow",
                "water_pressure",
                "pump_temperature",
                "pump_status",
                "solar_irradiance",
                "ambient_temperature",
                "ambient_humidity",
                "water_level",
                "water_ph",
                "water_turbidity"
            ]
        };

        // Variables MQTT
        let mqttClient = null;
        let isConnected = false;

        // Initialisation de la connexion MQTT
        function initMQTT() {
            const client = new Paho.MQTT.Client(
                mqttConfig.host,
                mqttConfig.port,
                mqttConfig.clientId
            );

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            
            const options = {
                useSSL: true,
                userName: mqttConfig.username,
                password: mqttConfig.password,
                onSuccess: onConnect,
                onFailure: onFailure
            };

            client.connect(options);
            mqttClient = client;
        }

        // Callback de connexion réussie
        function onConnect() {
            console.log("Connexion MQTT établie");
            isConnected = true;
            updateConnectionStatus(true);
            
            // Souscription aux topics
            mqttConfig.topics.forEach(topic => {
                mqttClient.subscribe(topic, { qos: 0 });
                console.log("Souscrit au topic: " + topic);
            });
        }

        // Callback d'échec de connexion
        function onFailure(error) {
            console.error("Échec de connexion MQTT:", error.errorMessage);
            isConnected = false;
            updateConnectionStatus(false);
            
            // Tentative de reconnexion après 5 secondes
            setTimeout(initMQTT, 5000);
        }

        // Callback de perte de connexion
        function onConnectionLost(response) {
            if (response.errorCode !== 0) {
                console.error("Connexion MQTT perdue:", response.errorMessage);
            }
            isConnected = false;
            updateConnectionStatus(false);
            
            // Tentative de reconnexion
            setTimeout(initMQTT, 5000);
        }

        // Callback de réception de message
        function onMessageArrived(message) {
            console.log("Message reçu:", message.destinationName, message.payloadString);
            updateLastUpdateTime();
            
            // Mise à jour de l'interface en fonction du topic
            switch(message.destinationName) {
                case "solar_voltage":
                    document.getElementById("solar-voltage").textContent = parseFloat(message.payloadString).toFixed(2);
                    break;
                case "solar_current":
                    document.getElementById("solar-current").textContent = parseFloat(message.payloadString).toFixed(2);
                    break;
                case "solar_power":
                    document.getElementById("solar-power").textContent = parseFloat(message.payloadString).toFixed(2);
                    break;
                case "battery_level":
                    const batteryLevel = parseFloat(message.payloadString);
                    document.getElementById("battery-level").textContent = batteryLevel.toFixed(0);
                    document.getElementById("battery-level-gauge").style.width = batteryLevel + "%";
                    break;
                case "water_flow":
                    document.getElementById("water-flow").textContent = parseFloat(message.payloadString).toFixed(1);
                    break;
                case "water_pressure":
                    document.getElementById("water-pressure").textContent = parseFloat(message.payloadString).toFixed(1);
                    break;
                case "pump_temperature":
                    document.getElementById("pump-temperature").textContent = parseFloat(message.payloadString).toFixed(1);
                    break;
                case "pump_status":
                    document.getElementById("pump-status").textContent = message.payloadString;
                    break;
                case "solar_irradiance":
                    document.getElementById("solar-irradiance").textContent = parseFloat(message.payloadString).toFixed(0);
                    break;
                case "ambient_temperature":
                    document.getElementById("ambient-temperature").textContent = parseFloat(message.payloadString).toFixed(1);
                    break;
                case "ambient_humidity":
                    document.getElementById("ambient-humidity").textContent = parseFloat(message.payloadString).toFixed(0);
                    break;
                case "water_level":
                    const waterLevel = parseFloat(message.payloadString);
                    document.getElementById("water-level").textContent = waterLevel.toFixed(0);
                    document.getElementById("water-level-gauge").style.width = waterLevel + "%";
                    break;
                case "water_ph":
                    document.getElementById("water-ph").textContent = parseFloat(message.payloadString).toFixed(1);
                    break;
                case "water_turbidity":
                    document.getElementById("water-turbidity").textContent = parseFloat(message.payloadString).toFixed(1);
                    break;
            }
        }

        // Mise à jour du statut de connexion
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById("mqtt-status");
            const statusText = document.getElementById("mqtt-status-text");
            
            if (connected) {
                statusIndicator.className = "status-indicator status-connected";
                statusText.textContent = "Connecté";
            } else {
                statusIndicator.className = "status-indicator status-disconnected";
                statusText.textContent = "Déconnecté";
            }
        }

        // Mise à jour de l'heure de dernière réception
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById("last-update").textContent = `Dernière mise à jour: ${timeString}`;
        }

        // Initialisation au chargement de la page
        document.addEventListener("DOMContentLoaded", function() {
            initMQTT();
            updateLastUpdateTime();
        });
    </script>
</body>
</html>
