<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Monitoring</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f0f4f8, #e0e8f0);
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 20px;
        }
        #welcome {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .section {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        .section-title {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        .section-content {
            padding: 10px;
        }
        .collapsed {
            max-height: 0;
            padding: 0;
        }
        .expanded {
            max-height: 500px; /* Adjust based on content */
        }
        .topic-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ccc;
            transition: background-color 0.3s;
        }
        .green-led.on { background-color: #00ff00; }
        .red-led.on { background-color: #ff0000; }
        .slider {
            width: 100%;
            height: 20px;
            -webkit-appearance: none;
            background: #dfe6e9;
            border-radius: 10px;
            outline: none;
            pointer-events: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            cursor: default;
        }
        .slider[value="0"]::-webkit-slider-thumb { background: #e74c3c; }
        .slider[value="30"]::-webkit-slider-thumb,
        .slider[value="31"]::-webkit-slider-thumb { background: #f39c12; }
        .slider[value="60"]::-webkit-slider-thumb,
        .slider[value="61"]::-webkit-slider-thumb { background: #2ecc71; }
        .slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #2ecc71;
            cursor: default;
        }
        .slider[value="0"]::-moz-range-thumb { background: #e74c3c; }
        .slider[value="30"]::-moz-range-thumb,
        .slider[value="31"]::-moz-range-thumb { background: #f39c12; }
        .slider[value="60"]::-moz-range-thumb,
        .slider[value="61"]::-moz-range-thumb { background: #2ecc71; }
        button {
            padding: 5px 10px;
            margin: 5px;
            background-color: #2c3e50;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #34495e;
        }
        #log {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #dfe6e9;
            padding: 10px;
        }
        .log-entry {
            margin: 5px 0;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <h1 id="client-title">Client Monitoring</h1>
    <div id="welcome"></div>
    <div id="status">Not Connected</div>
    <div class="section">
        <div class="section-title" onclick="toggleSection('system')">Etat de System</div>
        <div id="system-content" class="section-content collapsed">
            <div class="topic-row"><span>Source d'energie:</span><span id="energy-source">N/A</span></div>
            <div class="topic-row"><span>Electricité produite:</span><span id="electricity-produced">N/A</span></div>
            <div class="topic-row"><span>Electricité consommé:</span><span id="electricity-consumed">N/A</span></div>
        </div>
    </div>
    <div class="section">
        <div class="section-title" onclick="toggleSection('levels')">Niveau de Batterie & Eau</div>
        <div id="levels-content" class="section-content collapsed">
            <div class="topic-row"><span>Niveau de Batterie:</span><input type="range" id="battery-level" class="slider" min="0" max="100" value="0"><span id="battery-value">0%</span></div>
            <div class="topic-row"><span>Niveau d'eau (Reservoir):</span><input type="range" id="water-level" class="slider" min="0" max="100" value="0"><span id="water-value">0%</span></div>
        </div>
    </div>
    <div class="section">
        <div class="section-title" onclick="toggleSection('pump')">Control de Pompe</div>
        <div id="pump-content" class="section-content collapsed">
            <div class="topic-row"><span>Etat de Pompe:</span><div id="pump-led" class="led red-led"></div></div>
            <button onclick="sendCommand('pump/start')">Démarrer</button>
            <button onclick="sendCommand('pump/stop')">Arrêter</button>
        </div>
    </div>
    <div class="section">
        <div class="section-title" onclick="toggleSection('program')">Programmation</div>
        <div id="program-content" class="section-content collapsed">
            <input type="datetime-local" id="program-time">
            <button onclick="addProgram()">Ajouter Programme</button>
            <ul id="program-list"></ul>
        </div>
    </div>
    <div class="section">
        <div class="section-title" onclick="toggleSection('log')">Log des Informations</div>
        <div id="log-content" class="section-content collapsed">
            <div id="log"></div>
        </div>
    </div>
    <button onclick="disconnect()">Déconnexion</button>
    <script src="https://unpkg.com/mqtt@5.10.1/dist/mqtt.min.js"></script>
    <script>
        let client;
        const topics = ['system/energy-source', 'system/electricity-produced', 'system/electricity-consumed', 'battery/level', 'water/level', 'pump/state'];
        const programs = [];

        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            content.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        }

        function getParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const username = getParameter('username');
        if (username) {
            document.getElementById('client-title').textContent = `Client: ${username}`;
            document.getElementById('welcome').textContent = `Bienvenue ${username} (Client)`;
        }

        function connect() {
            const statusDiv = document.getElementById('status');
            const options = {
                host: '508205b2e19c4a7fad9828d3961d6424.s1.eu.hivemq.cloud',
                port: 8884,
                protocol: 'wss',
                path: '/mqtt',
                clientId: 'mqttjs_' + Math.random().toString(16).substr(2, 8),
                username: username,
                password: 'Nasrollah2003*' // Replace with actual password or fetch securely
            };

            statusDiv.textContent = 'Connecting...';
            client = mqtt.connect(options);

            client.on('connect', () => {
                statusDiv.textContent = 'Connected to HiveMQ Cloud';
                statusDiv.style.color = 'green';
                topics.forEach(topic => client.subscribe(topic));
                setInterval(logStatus, 60000); // Log every minute
            });

            client.on('message', (topic, message) => {
                const msg = message.toString();
                switch (topic) {
                    case 'system/energy-source':
                        document.getElementById('energy-source').textContent = msg;
                        break;
                    case 'system/electricity-produced':
                        document.getElementById('electricity-produced').textContent = msg;
                        break;
                    case 'system/electricity-consumed':
                        document.getElementById('electricity-consumed').textContent = msg;
                        break;
                    case 'battery/level':
                        updateLevel('battery-level', msg, 'battery-value');
                        break;
                    case 'water/level':
                        updateLevel('water-level', msg, 'water-value');
                        break;
                    case 'pump/state':
                        const pumpLed = document.getElementById('pump-led');
                        pumpLed.classList.remove('on');
                        if (msg.toLowerCase().includes('on')) pumpLed.classList.add('on', 'green-led');
                        else pumpLed.classList.add('on', 'red-led');
                        break;
                }
            });

            client.on('error', (err) => {
                console.log('Connection error:', err);
                statusDiv.textContent = 'Error: Connection failed';
                statusDiv.style.color = 'red';
                window.location.href = 'login.html';
            });

            client.on('close', () => {
                window.location.href = 'login.html';
            });
        }

        function updateLevel(elementId, value, displayId) {
            const slider = document.getElementById(elementId);
            const display = document.getElementById(displayId);
            let val = Math.max(0, Math.min(100, parseInt(value) || 0));
            slider.value = val;
            display.textContent = `${val}%`;
        }

        function sendCommand(command) {
            if (client) {
                const topic = `pump/control`;
                let payload = '';
                if (command === 'pump/start') payload = 'ON';
                else if (command === 'pump/stop') payload = 'OFF';
                client.publish(topic, payload);
            }
        }

        function addProgram() {
            const time = document.getElementById('program-time').value;
            if (time) {
                programs.push(time);
                const list = document.getElementById('program-list');
                const li = document.createElement('li');
                li.textContent = time;
                list.appendChild(li);
                document.getElementById('program-time').value = '';
            }
        }

        function logStatus() {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] Logged status`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function disconnect() {
            if (client) client.end();
        }

        // Connect on page load
        window.onload = connect;
    </script>
</body>
</html>
